{% extends 'base.html' %}

{% load static %}


{% block title %} Viaje Fácil {% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/lista_hoteles.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mt-3">
        <div style="background-color: #c8efc1;" class="col-7 mb-4 border rounded-4 border-transparent">
            <div class="container mt-4">
                <h2 class="fs-1">¡Ya casi estás! Completá tus datos y finalizá tu compra</h2>

                <form id="form-reserva" method="post" action="{% url 'hotel:procesar_reserva' %}">
                    {% csrf_token %}
                    <p class="fs-2 mt-4">
                        ¿Quién es titular de la reserva?
                    </p>
                    <p class="fs-5 mt-0">
                        Será responsable de hacer el check-in y el check-out en el alojamiento
                    </p>
                    <div class="row">
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="nombre" class="form-label fs-5">Nombre<i
                                        class="bi bi-asterisk fs-6 ps-2"></i></label>
                                <input type="text" class="form-control border border-3 border-success" id="nombre"
                                    name="nombre_viajero" placeholder="Como figura en el documento">
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="mb-3">
                                <label for="apellido" class="form-label fs-5">Apellido <i
                                        class="bi bi-asterisk fs-6"></i></label>
                                <input type="text" class="form-control border border-3 border-success" id="apellido"
                                    name="apellido_viajero" placeholder="Como figura en el documento">
                            </div>
                        </div>
                    </div>
                    <div class="row border">
                        <div class="col-4">
                            <label for="documentType" class="form-label fs-5">Tipo de documento:</label>
                            <select class="form-select border border-3 border-success" id="documentType">
                                <option value="dni">DNI</option>
                                <option value="pasaporte">Pasaporte</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="identificacion" class="form-label fs-5">Número <i
                                        class="bi bi-asterisk fs-6"></i></label>
                                <input type="number" class="form-control border border-3 border-success"
                                    id="identificacion" name="identificacion_viajero">
                            </div>
                        </div>
                    </div>
                    <p class="fs-2 mt-3">
                        ¿A dónde enviamos tus vouchers?
                    </p>
                    <p class="fs-5 mt-0">
                        El email que elijas será fundamental para que gestiones tu reserva y recibas información
                        importante
                        sobre tu
                        viaje
                    </p>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label for="email" class="form-label fs-5">Email <i class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="email_viajero"
                                name="email_viajero" placeholder="Ingresa tu email" required>
                        </div>
                    </div>

                    <div class="row">

                        <p class="fs-2 mt-3">
                            ¿A qué número podríamos contactarte?
                        </p>
                        <div class="col-3">
                            <label for="phoneType" class="form-label fs-5 ">Teléfono:</label>
                            <select class="form-select border border-3 border-success" id="phoneType">
                                <option value="celular">Celular</option>
                                <option value="particular">Particular</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <label for="telefono" class="form-label fs-5">Código de país <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="number" class="form-control border border-3 border-success" id="codigo_pais"
                                name="codigo_pais" placeholder="Argentina (54)">
                        </div>
                        <div class="col-4 mb-3">
                            <label for="telefono" class="form-label fs-5">Número <i
                                    class="bi bi-asterisk fs-6"></i></i></label>
                            <input type="number" class="form-control border border-3 border-success" id="telefono"
                                name="telefono_viajero" placeholder="Ingresa tu número">
                        </div>
                    </div>

                    <div class="row">
                        <p class="fs-2 mt-3 mb-1">
                            ¿Cuándo naciste?
                        </p>
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="fecha_nacimiento" class="form-label fs-5">Fecha de nacimiento <i
                                        class="bi bi-asterisk fs-6"></i></label>
                                <input type="date" class="form-control border border-3 border-success fs-5"
                                    id="fecha_nacimiento" name="fecha_nacimiento_viajero">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <p class="fs-2 mt-3 mb-1">
                            ¿Donde vivís?
                        </p>
                        <div class="col-4">
                            <label for="pais" class="form-label fs-5">País <i class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="pais" name="pais"
                                placeholder="Argentina">
                        </div>
                        <div class="col-4">
                            <label for="provincia" class="form-label fs-5">Provincia <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="provincia"
                                name="provincia" placeholder="Corrientes">
                        </div>
                        <div class="col-4">
                            <label for="localidad" class="form-label fs-5">Localidad <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="localidad"
                                name="localidad" placeholder="Corrientes">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-4 mt-2">
                            <label for="codpostal" class="form-label fs-5">Cod. Postal <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="codpostal"
                                name="codpostal">
                        </div>
                        <div class="col-4 mt-2">
                            <label for="calle" class="form-label fs-5">Calle <i class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="calle"
                                name="calle">
                        </div>
                        <div class="col-4 mt-2">
                            <label for="numero" class="form-label fs-5">Número <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="numero"
                                name="numero">
                        </div>
                    </div>

                    <div class="row mt-4">
                        <p class="fs-2 mt-3 mb-1">
                            ¿Cómo querés pagar?
                        </p>
                        <div class="col-6">
                            <label for="nro_tarjeta" class="form-label fs-5">Número de la tarjeta <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="nro_tarjeta"
                                name="nro_tarjeta" required pattern="^\d{15,19}$"
                                title="Debe tener entre 15 y 19 dígitos numéricos.">
                        </div>
                        <div class="col-3">
                            <label for="cod_seguridad" class="form-label fs-5">Cod. Seguridad <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="cod_seguridad"
                                name="cod_seguridad" required pattern="^\d{3}$"
                                title="Debe tener exactamente 3 dígitos.">
                        </div>
                        <div class="col-3">
                            <label for="vencimiento_tarjeta" class="form-label fs-5">Vencimiento <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success"
                                id="vencimiento_tarjeta" name="vencimiento_tarjeta" required
                                pattern="^(0[1-9]|1[0-2])([0-9]{2})$" title="Formato válido: MMYY (ejemplo: 0426).">
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-6">
                            <label for="nombre_titular" class="form-label fs-5">Nombre titular <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="nombre"
                                name="nombre_viajero" required pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                                title="Solo se permiten letras y espacios.">
                        </div>
                        <div class="col-6">
                            <label for="dni_titular" class="form-label fs-5">DNI titular <i
                                    class="bi bi-asterisk fs-6"></i></label>
                            <input type="text" class="form-control border border-3 border-success" id="identificacion"
                                name="identificacion_viajero" required pattern="^\d{6,8}$"
                                title="Debe tener entre 6 y 8 dígitos." inputmode="numeric">

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mt-5">
                            <div class="form-check">
                                <input class="form-check-input border border-3 border-success" type="checkbox"
                                    id="terms">
                                <label class="form-check-label fs-5" for="terms">
                                    Leí y acepto las condiciones de compra, políticas de privacidad y políticas de
                                    cambios y
                                    cancelaciones.
                                </label>
                            </div>
                        </div>
                        <div class="col-6 offset-5 pb-3 pt-3">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success fs-5">Finalizar reserva</button>
                </form>

            </div>
        </div>
    </div>
</div>

<div class="col-4 ms-5">
    <div class="row">
        <div class="col-12">
            <p class="fs-3 ps-1 mt-3 mb-0">
                Detalle del pago
            </p>
        </div>
        <div style="background-color: #c8efc1;" class="container border rounded-4 border-transparent">

            <div class="row pt-3">
                <div class="col-8">
                    <p class="fs-5">
                        Alojamiento para {{ request.session.busqueda.cantidad_personas|default:1 }} personas
                    </p>
                </div>
                <div class="col-4">
                    <p class="fs-5">
                        <i class="bi bi-currency-dollar fs-6 text-success"></i>
                        {{ precio_reserva }}
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-8">
                    <p class="fs-5">
                        Impuestos y tasas
                    </p>
                </div>
                <div class="col-4">
                    <p class="fs-5">
                        <i class="bi bi-currency-dollar fs-6 text-success"></i>
                        {{ impuestos }}
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-8">
                    <p class="fs-5">
                        Cargos
                    </p>
                </div>
                <div class="col-4">
                    <p class="fs-5">
                        <i class="bi bi-currency-dollar fs-6 text-success"></i>
                        {{ cargos }}
                    </p>
                </div>
            </div>
            <div class="row border-top border-white border-3">
                <div class="col-7 pt-3">
                    <p class="fs-4 fw-bold">TOTAL</p>
                </div>
                <div class="col-5 pt-3">
                    <p class="fs-4 fw-bold ">
                        <i class="bi bi-currency-dollar fs-4"></i>{{ precio_final}}
                    </p>
                </div>
            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-12">
            <p class="fs-3 ps-2 mt-4 mb-0">
                Detalle de la compra
            </p>
            <div style="background-color: #c8efc1;" class="container border rounded-4 border-transparent">
                <div class="row">
                    <div class="col-8 pt-2">
                        <i class="bi bi-house-door fs-1"></i>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p class="fs-5">
                            <span class="fs-4">
                                {{ hotel.nombre_hotel }}
                            </span>
                            <br>
                            {% for _ in estrellas %}
                            <i class="bi bi-star-fill text-warning fs-5"></i>
                            {% endfor %}
                            <br>{{ hotel.Direccion }}
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <p class="fs-5">Check in
                            <br><span class="fw-bold">{{ fecha_ingreso_fmt }}</span>
                            <br>9:00 h
                        </p>
                    </div>
                    <div class="col-6">
                        <p class="fs-5">Check out
                            <br><span class="fw-bold">{{ fecha_egreso_fmt }}</span>
                            <br>10:00 h
                        </p>
                    </div>
                </div>
                <div class="row">
                    <div class="col border-top border-white border-3">
                        <p class="fs-5 pt-3">

                            {{ cantidad_noches }} noches, {{ personas }}
                            personas
                            <br>
                            {% for hab in combinacion %}
                            {{ hab.nombre_categoria }} {{ hab.descripcion_categoria }}<br>
                            {% endfor %}

                        </p>
                    </div>
                </div>


            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block script %}
<script>
    const DESTINOS_API_URL = "{% url 'hotel:api_destinos' %}";
</script>
<script src="{% static 'js/lista_hoteles.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('form-reserva');

        form.addEventListener('submit', function (e) {
            const campos = [
                { id: 'nombre', nombre: 'Nombre' },
                { id: 'apellido', nombre: 'Apellido' },
                { id: 'identificacion', nombre: 'Número de identificación' },
                { id: 'email_viajero', nombre: 'Email' },
                { id: 'codigo_pais', nombre: 'Código de país' },
                { id: 'telefono', nombre: 'Número de teléfono' },
                { id: 'fecha_nacimiento', nombre: 'Fecha de nacimiento' },
                { id: 'pais', nombre: 'País' },
                { id: 'provincia', nombre: 'Provincia' },
                { id: 'localidad', nombre: 'Localidad' },
                { id: 'codpostal', nombre: 'Código Postal' },
                { id: 'calle', nombre: 'Calle' },
                { id: 'numero', nombre: 'Número de calle' },
            ];

            let mensajeError = "";
            let errores = [];

            for (const campo of campos) {
                const input = document.getElementById(campo.id);
                if (!input || !input.value.trim()) {
                    errores.push(`• El campo "${campo.nombre}" es obligatorio.`);
                }
            }
            // Validación personalizada del correo electrónico
            const email = document.getElementById('email_viajero');
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
                errores.push("• El correo debe tener el siguiente formato: ejemplo@dominio.com");
            }

            // Validación personalizada del DNI
            const dni = document.getElementById('identificacion');
            if (dni && (dni.value.length < 6 || dni.value.length > 8)) {
                errores.push("• El número de DNI debe tener entre 6 y 8 dígitos.");
            }

            // Validación del teléfono
            // Validación del teléfono (con código de país)
            const codigoPais = document.getElementById('codigo_pais');
            const telefono = document.getElementById('telefono');
            if (codigoPais && telefono) {
                const numCompleto = (codigoPais.value + telefono.value).replace(/\D/g, ''); // eliminamos cualquier caracter no numérico
                if (numCompleto.length < 5 || numCompleto.length > 15) {
                    errores.push("• El número de teléfono es inválido.");
                }
            }

            // Validación de la fecha de nacimiento (no más de 100 años atrás)
            const nacimiento = document.getElementById('fecha_nacimiento');
            if (nacimiento && nacimiento.value) {
                const fechaNac = new Date(nacimiento.value);
                const hoy = new Date();
                const hace100Anios = new Date(hoy.getFullYear() - 100, hoy.getMonth(), hoy.getDate());
                if (fechaNac < hace100Anios) {
                    errores.push("• La fecha de nacimiento no puede ser mayor a 100 años.");
                }
            }

            // Validación de fecha de nacimiento (mayor de edad y no futura)
            if (nacimiento && nacimiento.value) {
                const fechaNac = new Date(nacimiento.value);
                const hoy = new Date();

                const hace18Anios = new Date(hoy.getFullYear() - 18, hoy.getMonth(), hoy.getDate());

                if (fechaNac > hoy) {
                    errores.push("• La fecha de nacimiento no puede ser en el futuro.");
                } else if (fechaNac > hace18Anios) {
                    errores.push("• Debés ser mayor de 18 años para realizar una reserva.");
                }
            }



            // Validación de los términos
            const terms = document.getElementById('terms');
            if (!terms.checked) {
                errores.push("• Debe aceptar las condiciones de compra.");
            }

            // Mostrar errores si hay
            if (errores.length > 0) {
                e.preventDefault();
                alert("Error: hay datos incorrectos o hay algún campo vacío.\n\n" + errores.join("\n"));
            }
        });
    });

</script>



{% endblock %}